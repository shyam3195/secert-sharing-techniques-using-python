<html>

<head>
    <!-- Bootstrap and Jquery CDN imported -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="scripts/utils.js"></script>

    <script>
        let system_users = []
        let current_user_req_connections = []
        let current_user_connect = []
        let current_user_yet_to_accept = []
        let connections = []
        let user_public_key = null
        const user_id = localStorage.getItem('user_id')
        $(document).ready(function() {
            let text_result = null
            $("#encrypt_result").hide()
            $("#decrypt_result").hide()
            $("#encrypt_text_div").hide()
            $("#text_file_div").hide()
            $(".username").text(localStorage.getItem('username'))
            $(".email").text(localStorage.getItem('email'))
            $(".user_id").text(user_id)

            getCurrentUser()

            $(document).on("click", "a.accept_connect_but", function() {
                body = JSON.stringify({
                    "user_id": user_id,
                    "userid_to_accept": event.target.id
                })
                fetch("http://127.0.0.1:5000/accept/connect", {
                        method: 'POST',
                        body: body,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        window.location.reload()
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            })


            $("#connect_btn").click(function() {
                    let body = JSON.stringify({
                        "current_user_id": user_id,
                        "requesting_user_id": $('#users').find(":selected").attr("id")
                    });
                    fetch("http://127.0.0.1:5000/request/connect", {
                            method: 'POST',
                            body: body,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                        })
                        .then(response => response.json())
                        .then(res => window.location.reload())
                        .catch((error) => {
                            console.error('Error:', error);
                        });
                })
                // On File type component changes - file type [text field, text file]
                // if text field is choosen, show the text field and hide text file
                // if text file is choosen, show the text file and hide text field
            $("#file_type").change(function() {
                const changed_file_val = $("#file_type").val();
                if (changed_file_val === 'tx_field') {
                    $("#encrypt_text_div").show()
                    $("#txt_data_field").show()
                } else {
                    $("#encrypt_text_div").hide()
                    $("#txt_data_field").hide()
                }
                if (changed_file_val === 'text_file') {
                    $("#text_file_div").show()
                } else {
                    $("#text_file_div").hide()
                }
            })

            // On Encrypt button is clicked, call the encrypt api in backend
            $('#encrypt_submit_btn').click(function() {

                // Choose the Selected file type
                const selected_file_type = $('#file_type').find(":selected").text();

                const text_val = {
                    "data_to_encrypt": $("#txt_data_field").val(), // typed text data for encryption
                    "email": $("#email_txt").val(), // typed email value
                    "receiver_pub_key": $("#receiver_pub_key").val(), // typed receiver public key
                    "receiver_id": $('#users_encrypt').find(":selected").attr("id"),
                    "sender_id": user_id,
                    "sender_public_key": user_public_key
                }

                // Only if the file element is choosen, data_to_encrypt is changed as text_result variable
                // which is the data read from file uploaded
                if (selected_file_type === 'Text File') {
                    text_val['data_to_encrypt'] = text_result
                }
                let body = JSON.stringify(text_val)
                    // Using Fetch to do the API call
                fetch("http://127.0.0.1:5000/encrypt/aes", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: body,
                    })
                    .then(response => response.json())
                    .then(data => {
                        $("#encrypt_result").val(JSON.stringify(data.data))
                        $("#decrypt_div").show()
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            })

            // On Decrypt button is clicked, call the decrypt api in backend
            $('#decrypt_submit_btn').click(function() {

                const text_val = {
                    "encrypted_data": $("#decrypt_text").val(),
                    "sender_public_key": $("#sender_pub_key").val(),
                    "user_id": user_id
                }

                fetch("http://127.0.0.1:5000/decrypt/aes", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(text_val),
                    })
                    .then(response => response.json())
                    .then(data => {
                        // After the data success came, showing the decrypted result
                        $("#decrypt_result").val(JSON.stringify(data.data))
                        $("#decrypt_result").show()
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            })

            // Whenever the file upload button clicked or changed
            // Read the content of the file and store in text_result variable
            const fileUploader = document.getElementById('file_upload');
            fileUploader.addEventListener('change', (event) => {
                files = event.target.files[0];
                var fileReader = new FileReader();
                fileReader.onload = function(fileLoadedEvent) {
                    text_result = fileLoadedEvent.target.result
                };
                fileReader.readAsText(files, "UTF-8");
            });

        });
    </script>
    <title>
        Shyam Security Project
    </title>
    <style>
        body {
            background: #eee;
            margin-top: 0px;
        }
        
        .price-tabs {
            background-color: #fff;
            -webkit-box-shadow: 0 5px 20px 0 rgba(39, 39, 39, 0.1);
            box-shadow: 0 5px 20px 0 rgba(39, 39, 39, 0.1);
            display: inline-block;
            padding: 7px;
            border-radius: 40px;
            border: 1px solid #00b5ec;
            margin-bottom: 45px;
        }
        
        @media (min-width: 768px) {
            .price-tabs {
                margin-bottom: 20px;
            }
        }
        
        .price-tabs .nav-link {
            color: #00b5ec;
            font-weight: 500;
            font-family: "Montserrat", sans-serif;
            font-size: 16px;
            padding: 12px 35px;
            display: inline-block;
            text-transform: capitalize;
            border-radius: 40px;
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .price-tabs .nav-link {
                padding: 12px 40px;
            }
        }
        
        .price-tabs .nav-link.active {
            background-color: #00b5ec;
            color: #fff;
        }
        
        .crypto-method {
            background-color: #fff;
            -webkit-box-shadow: 0 5px 30px 0 rgba(39, 39, 39, 0.15);
            box-shadow: 0 5px 30px 0 rgba(39, 39, 39, 0.15);
            border-radius: 50px;
        }
        
        @media (min-width: 768px) {
            .crypto-method {
                margin: 0 20px;
                padding: 60px;
                padding-bottom: 50px;
            }
        }
        
        .selected {
            background-color: #00b5ec;
        }
        
        .inner-cypto {
            padding: 60px;
            padding-left: 150px;
        }
        
        .float-left {
            margin-left: 0px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="text-center">
            <div class="nav price-tabs" role="tablist">
                <a class="nav-link active" href="#profile" role="tab" data-toggle="tab">Profile</a>
                <a class="nav-link" href="#connect" role="tab" data-toggle="tab">Connect</a>
                <a class="nav-link" href="#encryption" role="tab" data-toggle="tab">Encryption</a>
                <a class="nav-link" href="#decryption" role="tab" data-toggle="tab">Decryption</a>
            </div>
        </div>
        <div class="tab-content wow fadeIn" style="visibility: visible; animation-name: fadeIn;">
            <div role="tabpanel" class="tab-pane fade show active" id="profile">
                <div class="row justify-content-center">
                    <div class="crypto-method text-center selected">
                        <div class="container">
                            <div class="main-body">
                                <div class="row gutters-sm">
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex flex-column align-items-center text-center">
                                                    <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Admin" class="rounded-circle" width="150">
                                                    <div class="mt-3">
                                                        <h4 class="username"></h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="col-md-8">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Full Name</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary username">
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Email</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary email">
                                                        fip@jukmuh.al
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Connections</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary connections">
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">User ID</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary user_id">
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <a class="btn btn-info " href="http://localhost:3000/login">Logout</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="connect">
                <div class="row justify-content-center">
                    <div class="crypto-method text-center selected">
                        <div class="container">
                            <div class="main-body">
                                <div class="row gutters-sm">
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex flex-column align-items-center text-center">
                                                    <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Admin" class="rounded-circle" width="150">
                                                    <div class="mt-3">
                                                        <h4 class="username"></h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Connections</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary connections">
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Waiting Connections</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary waiting_connections">
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Connections yet to be accepted</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary accept_connections">
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-3">
                                                        <h6 class="mb-0">Connect User</h6>
                                                    </div>
                                                    <div class="col-sm-9 text-secondary">
                                                        <select name="users" id="users">
                                                        </select>
                                                    </div>

                                                </div>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <a class="btn btn-info " id="connect_btn" target="__blank">Connect</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="encryption">
                <div class="row justify-content-center">
                    <div class="crypto-method text-center selected">
                        <div class="container">
                            <div class="main-body">
                                <div class="row gutters-sm">
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex flex-column align-items-center text-center">
                                                    <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Admin" class="rounded-circle" width="150">
                                                    <div class="mt-3">
                                                        <h4 class="username"></h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="form-group">
                                                    <label class="float-left" for="user">Choose User:</label>
                                                    <select name="user" id="users_encrypt" aria-label="Default select example">
                                                        </select>
                                                </div>
                                                <div class="form-group">
                                                    <label class="float-left" for="file">Input file type:</label>
                                                    <select name="file" id="file_type" class="selectpicker" aria-label="Default select example">
                                                            <option value="null">Choose the type of data</option>
                                                            <option value="tx_field">Text field</option>
                                                            <option value="text_file">Text File</option>
                                                        </select>
                                                </div>
                                                <div class="form-group" id="encrypt_text_div">
                                                    <label class="float-left" for="data">Input text:</label>
                                                    <input id="txt_data_field" class="form-control" type="text" style="display: none;" />
                                                </div>
                                                <div class="form-group" id="text_file_div">
                                                    <label class="form-label float-left" for="customFile">Text File</label>
                                                    <input type="file" class="form-control" id="file_upload" />
                                                </div>
                                                <div class="form-group">
                                                    <label class="float-left" for="file">Receiver Public Key</label>
                                                    <input type="text" class="form-control" id="receiver_pub_key" />
                                                </div>
                                                <div class="form-group">
                                                    <label class="float-left" for="file">Receiver Email</label>
                                                    <input type="text" class="form-control" id="email_txt" />
                                                </div>
                                                <button type="submit" id="encrypt_submit_btn" class="btn btn-info btn-block">Encrypt</button>
                                                <div class="form-group">
                                                    <textarea id="encrypt_result" cols="50" rows="20"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>

                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="decryption">
                <div class="row justify-content-center">
                    <div class="crypto-method text-center selected">
                        <div class="container">
                            <div class="main-body">
                                <div class="row gutters-sm">
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex flex-column align-items-center text-center">
                                                    <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Admin" class="rounded-circle" width="150">
                                                    <div class="mt-3">
                                                        <h4 class="username"></h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="form-group">
                                                    <div class="form-group">
                                                        <label for="decrypt_text">Decrypt Text</label>
                                                        <textarea name="decrypt_text" id="decrypt_text" cols="30" rows="8"></textarea><br />
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="float-left" for="file">Sender Public Key</label>
                                                        <input type="text" class="form-control" id="sender_pub_key" />
                                                    </div>
                                                    <div class="form-group">
                                                        <textarea id="decrypt_result" cols="50" rows="6"></textarea><br />
                                                    </div>
                                                    <button type="submit" id="decrypt_submit_btn" class="btn btn-info btn-lg btn-block">
                                                        Decrypt
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>
</body>

</html>